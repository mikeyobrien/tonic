dXNlIGNyYXRlOjppcjo6e0lyQ2FsbFRhcmdldCwgSXJGb3JHZW5lcmF0b3IsIElyT3AsIElyUGF0dGVybSwgSXJQcm9ncmFtfTsKdXNlIGNyYXRlOjpuYXRpdmVfcnVudGltZTsKdXNlIHN0ZDo6Y29sbGVjdGlvbnM6Okhhc2hNYXA7CnVzZSBzdGQ6OmZtdDsKCmNvbnN0IEVOVFJZUE9JTlQ6ICZzdHIgPSAiRGVtby5ydW4iOwpjb25zdCBGT1JfUkVEVUNFX0FDQ19CSU5ESU5HOiAmc3RyID0gIl9fdG9uaWNfZm9yX2FjYyI7CgojW2Rlcml2ZShEZWJ1ZywgQ2xvbmUsIFBhcnRpYWxFcSwgRXEpXQpwdWIgc3RydWN0IFJ1bnRpbWVDbG9zdXJlIHsKICAgIHBhcmFtczogVmVjPFN0cmluZz4sCiAgICBvcHM6IFZlYzxJck9wPiwKICAgIGVudjogSGFzaE1hcDxTdHJpbmcsIFJ1bnRpbWVWYWx1ZT4sCn0KCiNbZGVyaXZlKERlYnVnLCBDbG9uZSwgUGFydGlhbEVxLCBFcSldCnB1YiBlbnVtIFJ1bnRpbWVWYWx1ZSB7CiAgICBJbnQoaTY0KSwKICAgIEZsb2F0KFN0cmluZyksCiAgICBCb29sKGJvb2wpLAogICAgTmlsLAogICAgU3RyaW5nKFN0cmluZyksCiAgICBBdG9tKFN0cmluZyksCiAgICBSZXN1bHRPayhCb3g8UnVudGltZVZhbHVlPiksCiAgICBSZXN1bHRFcnIoQm94PFJ1bnRpbWVWYWx1ZT4pLAogICAgVHVwbGUoQm94PFJ1bnRpbWVWYWx1ZT4sIEJveDxSdW50aW1lVmFsdWU+KSwKICAgIE1hcChWZWM8KFJ1bnRpbWVWYWx1ZSwgUnVudGltZVZhbHVlKT4pLAogICAgS2V5d29yZChWZWM8KFJ1bnRpbWVWYWx1ZSwgUnVudGltZVZhbHVlKT4pLAogICAgTGlzdChWZWM8UnVudGltZVZhbHVlPiksCiAgICBSYW5nZShpNjQsIGk2NCksCiAgICBTdGVwcGVkUmFuZ2UoaTY0LCBpNjQsIGk2NCksCiAgICBDbG9zdXJlKEJveDxSdW50aW1lQ2xvc3VyZT4pLAp9CgppbXBsIFJ1bnRpbWVWYWx1ZSB7CiAgICBwdWIgZm4gcmVuZGVyKCZzZWxmKSAtPiBTdHJpbmcgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpJbnQodmFsdWUpID0+IHZhbHVlLnRvX3N0cmluZygpLAogICAgICAgICAgICBTZWxmOjpGbG9hdCh2YWx1ZSkgPT4gdmFsdWUuY2xvbmUoKSwKICAgICAgICAgICAgU2VsZjo6Qm9vbCh2YWx1ZSkgPT4gdmFsdWUudG9fc3RyaW5nKCksCiAgICAgICAgICAgIFNlbGY6Ok5pbCA9PiAibmlsIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgU2VsZjo6U3RyaW5nKHZhbHVlKSA9PiBmb3JtYXQhKCJcInt9XCIiLCB2YWx1ZSksCiAgICAgICAgICAgIFNlbGY6OkF0b20odmFsdWUpID0+IGZvcm1hdCEoIjp7dmFsdWV9IiksCiAgICAgICAgICAgIFNlbGY6OlJlc3VsdE9rKHZhbHVlKSA9PiBmb3JtYXQhKCJvayh7fSkiLCB2YWx1ZS5yZW5kZXIoKSksCiAgICAgICAgICAgIFNlbGY6OlJlc3VsdEVycih2YWx1ZSkgPT4gZm9ybWF0ISgiZXJyKHt9KSIsIHZhbHVlLnJlbmRlcigpKSwKICAgICAgICAgICAgU2VsZjo6VHVwbGUobGVmdCwgcmlnaHQpID0+IGZvcm1hdCEoInt7e30sIHt9fX0iLCBsZWZ0LnJlbmRlcigpLCByaWdodC5yZW5kZXIoKSksCiAgICAgICAgICAgIFNlbGY6Ok1hcChlbnRyaWVzKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgcmVuZGVyZWRfZW50cmllcyA9IGVudHJpZXMKICAgICAgICAgICAgICAgICAgICAuaXRlcigpCiAgICAgICAgICAgICAgICAgICAgLm1hcCh8KGtleSwgdmFsdWUpfCBmb3JtYXQhKCJ7fSA9PiB7fSIsIGtleS5yZW5kZXIoKSwgdmFsdWUucmVuZGVyKCkpKQogICAgICAgICAgICAgICAgICAgIC5jb2xsZWN0Ojo8VmVjPF8+PigpCiAgICAgICAgICAgICAgICAgICAgLmpvaW4oIiwgIik7CiAgICAgICAgICAgICAgICBmb3JtYXQhKCIle3t7cmVuZGVyZWRfZW50cmllc319fSIpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgU2VsZjo6S2V5d29yZChlbnRyaWVzKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgcmVuZGVyZWRfZW50cmllcyA9IGVudHJpZXMKICAgICAgICAgICAgICAgICAgICAuaXRlcigpCiAgICAgICAgICAgICAgICAgICAgLm1hcCh8KGtleSwgdmFsdWUpfCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZW5kZXJlZF9rZXkgPSBtYXRjaCBrZXkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgUnVudGltZVZhbHVlOjpBdG9tKGF0b20pID0+IGF0b20uY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8gPT4ga2V5LnJlbmRlcigpLAogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQhKCJ7cmVuZGVyZWRfa2V5fToge30iLCB2YWx1ZS5yZW5kZXIoKSkKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC5jb2xsZWN0Ojo8VmVjPF8+PigpCiAgICAgICAgICAgICAgICAgICAgLmpvaW4oIiwgIik7CiAgICAgICAgICAgICAgICBmb3JtYXQhKCJbe3JlbmRlcmVkX2VudHJpZXN9XSIpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgU2VsZjo6TGlzdChpdGVtcykgPT4gewogICAgICAgICAgICAgICAgbGV0IGl0ZW1zOiBWZWM8U3RyaW5nPiA9IGl0ZW1zLml0ZXIoKS5tYXAofGl0ZW18IGl0ZW0ucmVuZGVyKCkpLmNvbGxlY3QoKTsKICAgICAgICAgICAgICAgIGZvcm1hdCEoIlt7fV0iLCBpdGVtcy5qb2luKCIsICIpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIFNlbGY6OlJhbmdlKHN0YXJ0LCBlbmQpID0+IGZvcm1hdCEoInt9Li57fSIsIHN0YXJ0LCBlbmQpLAogICAgICAgICAgICBTZWxmOjpTdGVwcGVkUmFuZ2Uoc3RhcnQsIGVuZCwgc3RlcCkgPT4gZm9ybWF0ISgie30uLnt9Ly97fSIgLCBzdGFydCwgZW5kLCBzdGVwKSwKICAgICAgICAgICAgU2VsZjo6Q2xvc3VyZShjbG9zdXJlKSA9PiBmb3JtYXQhKCIjRnVuY3Rpb248e30+IiwgY2xvc3VyZS5wYXJhbXMubGVuKCkpLAogICAgICAgIH0KICAgIH0KCiAgICBmbiBraW5kX2xhYmVsKCZzZWxmKSAtPiAmJ3N0YXRpYyBzdHIgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpJbnQoXykgPT4gImludCIsCiAgICAgICAgICAgIFNlbGY6OkZsb2F0KF8pID0+ICJmbG9hdCIsCiAgICAgICAgICAgIFNlbGY6OkJvb2woXykgPT4gImJvb2wiLAogICAgICAgICAgICBTZWxmOjpOaWwgPT4gIm5pbCIsCiAgICAgICAgICAgIFNlbGY6OlN0cmluZyhfKSA9PiAic3RyaW5nIiwKICAgICAgICAgICAgU2VsZjo6QXRvbShfKSA9PiAiYXRvbSIsCiAgICAgICAgICAgIFNlbGY6OlJlc3VsdE9rKF8pIHwgU2VsZjo6UmVzdWx0RXJyKF8pID0+ICJyZXN1bHQiLAogICAgICAgICAgICBTZWxmOjpUdXBsZShfLCBfKSA9PiAidHVwbGUiLAogICAgICAgICAgICBTZWxmOjpNYXAoXykgPT4gIm1hcCIsCiAgICAgICAgICAgIFNlbGY6OktleXdvcmQoXykgPT4gImtleXdvcmQiLAogICAgICAgICAgICBTZWxmOjpMaXN0KF8pID0+ICJsaXN0IiwKICAgICAgICAgICAgU2VsZjo6UmFuZ2UoXywgXykgPT4gInJhbmdlIiwKICAgICAgICAgICAgU2VsZjo6U3RlcHBlZFJhbmdlKF8sIF8sIF8pID0+ICJzdGVwcGVkX3JhbmdlIiwKICAgICAgICAgICAgU2VsZjo6Q2xvc3VyZShfKSA9PiAiZnVuY3Rpb24iLAogICAgICAgIH0KICAgIH0KfQoKI1tkZXJpdmUoRGVidWcsIENsb25lLCBQYXJ0aWFsRXEsIEVxKV0KcHViIHN0cnVjdCBSdW50aW1lRXJyb3IgewogICAgbWVzc2FnZTogU3RyaW5nLAogICAgb2Zmc2V0OiBPcHRpb248dXNpemU+LAogICAgcHViIHJhaXNlZF92YWx1ZTogT3B0aW9uPFJ1bnRpbWVWYWx1ZT4sCn0KCmltcGwgUnVudGltZUVycm9yIHsKICAgIGZuIG5ldyhtZXNzYWdlOiBpbXBsIEludG88U3RyaW5nPikgLT4gU2VsZiB7CiAgICAgICAgU2VsZiB7CiAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UuaW50bygpLAogICAgICAgICAgICBvZmZzZXQ6IE5vbmUsCiAgICAgICAgICAgIHJhaXNlZF92YWx1ZTogTm9uZSwKICAgICAgICB9CiAgICB9CgogICAgZm4gYXRfb2Zmc2V0KG1lc3NhZ2U6IGltcGwgSW50bzxTdHJpbmc+LCBvZmZzZXQ6IHVzaXplKSAtPiBTZWxmIHsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZS5pbnRvKCksCiAgICAgICAgICAgIG9mZnNldDogU29tZShvZmZzZXQpLAogICAgICAgICAgICByYWlzZWRfdmFsdWU6IE5vbmUsCiAgICAgICAgfQogICAgfQoKICAgIGZuIHJhaXNlZCh2YWx1ZTogUnVudGltZVZhbHVlLCBvZmZzZXQ6IHVzaXplKSAtPiBTZWxmIHsKICAgICAgICBsZXQgbWVzc2FnZSA9IGV4dHJhY3RfcmFpc2VkX21lc3NhZ2UoJnZhbHVlKTsKICAgICAgICBTZWxmIHsKICAgICAgICAgICAgbWVzc2FnZSwKICAgICAgICAgICAgb2Zmc2V0OiBTb21lKG9mZnNldCksCiAgICAgICAgICAgIHJhaXNlZF92YWx1ZTogU29tZSh2YWx1ZSksCiAgICAgICAgfQogICAgfQp9CgpmbiBleHRyYWN0X3JhaXNlZF9tZXNzYWdlKHZhbHVlOiAmUnVudGltZVZhbHVlKSAtPiBTdHJpbmcgewogICAgbWF0Y2ggdmFsdWUgewogICAgICAgIFJ1bnRpbWVWYWx1ZTo6U3RyaW5nKHMpID0+IHMuY2xvbmUoKSwKICAgICAgICBSdW50aW1lVmFsdWU6OkF0b20oYSkgPT4gYS5jbG9uZSgpLAogICAgICAgIFJ1bnRpbWVWYWx1ZTo6TWFwKGVudHJpZXMpID0+IG1hcF9sb29rdXBfYXRvbShlbnRyaWVzLCAibWVzc2FnZSIpCiAgICAgICAgICAgIC5tYXAofG1lc3NhZ2V8IG1hdGNoIG1lc3NhZ2UgewogICAgICAgICAgICAgICAgUnVudGltZVZhbHVlOjpTdHJpbmcodGV4dCkgPT4gdGV4dC5jbG9uZSgpLAogICAgICAgICAgICAgICAgb3RoZXIgPT4gb3RoZXIucmVuZGVyKCksCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC51bndyYXBfb3JfZWxzZSh8fCAiZXhjZXB0aW9uIHJhaXNlZCIudG9fc3RyaW5nKCkpLAogICAgICAgIF8gPT4gImV4Y2VwdGlvbiByYWlzZWQiLnRvX3N0cmluZygpLAogICAgfQp9CgpmbiBtYXBfbG9va3VwX2F0b208J2E+KAogICAgZW50cmllczogJidhIFsoUnVudGltZVZhbHVlLCBSdW50aW1lVmFsdWUpXSwKICAgIGtleTogJnN0ciwKKSAtPiBPcHRpb248JidhIFJ1bnRpbWVWYWx1ZT4gewogICAgZW50cmllcy5pdGVyKCkuZmluZF9tYXAofChlbnRyeV9rZXksIHZhbHVlKXwgewogICAgICAgIGlmIGxldCBSdW50aW1lVmFsdWU6OkF0b20oYXRvbSkgPSBlbnRyeV9rZXkgewogICAgICAgICAgICAoYXRvbSA9PSBrZXkpLnRoZW5fc29tZSh2YWx1ZSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBOb25lCiAgICAgICAgfQogICAgfSkKfQoKaW1wbCBmbXQ6OkRpc3BsYXkgZm9yIFJ1bnRpbWVFcnJvciB7CiAgICBmbiBmbXQoJnNlbGYsIGY6ICZtdXQgZm10OjpGb3JtYXR0ZXI8J18+KSAtPiBmbXQ6OlJlc3VsdCB7CiAgICAgICAgaWYgbGV0IFNvbWUob2Zmc2V0KSA9IHNlbGYub2Zmc2V0IHsKICAgICAgICAgICAgd3JpdGUhKGYsICJ7fSBhdCBvZmZzZXQge30iLCBzZWxmLm1lc3NhZ2UsIG9mZnNldCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3cml0ZSEoZiwgInt9Iiwgc2VsZi5tZXNzYWdlKQogICAgICAgIH0KICAgIH0KfQoKaW1wbCBzdGQ6OmVycm9yOjpFcnJvciBmb3IgUnVudGltZUVycm9yIHt9CgpwdWIgZm4gZXZhbHVhdGVfZW50cnlwb2ludChwcm9ncmFtOiAmSXJQcm9ncmFtKSAtPiBSZXN1bHQ8UnVudGltZVZhbHVlLCBSdW50aW1lRXJyb3I+IHsKICAgIGV2YWx1YXRlX2Z1bmN0aW9uKHByb2dyYW0sIEVOVFJZUE9JTlQsICZbXSwgMCkKfQoKcHViIGZuIGV2YWx1YXRlX25hbWVkX2Z1bmN0aW9uKAogICAgcHJvZ3JhbTogJklyUHJvZ3JhbSwKICAgIGZ1bmN0aW9uX25hbWU6ICZzdHIsCikgLT4gUmVzdWx0PFJ1bnRpbWVWYWx1ZSwgUnVudGltZUVycm9yPiB7CiAgICBldmFsdWF0ZV9mdW5jdGlvbihwcm9ncmFtLCBmdW5jdGlvbl9uYW1lLCAmW10sIDApCn0KCmZuIGV2YWx1YXRlX2Z1bmN0aW9uKAogICAgcHJvZ3JhbTogJklyUHJvZ3JhbSwKICAgIGZ1bmN0aW9uX25hbWU6ICZzdHIsCiAgICBhcmdzOiAmW1J1bnRpbWVWYWx1ZV0sCiAgICBjYWxsX29mZnNldDogdXNpemUsCikgLT4gUmVzdWx0PFJ1bnRpbWVWYWx1ZSwgUnVudGltZUVycm9yPiB7CiAgICBsZXQgYWxsX2NhbmRpZGF0ZXMgPSBwcm9ncmFtCiAgICAgICAgLmZ1bmN0aW9ucwogICAgICAgIC5pdGVyKCkKICAgICAgICAuZmlsdGVyKHxmdW5jdGlvbnwgZnVuY3Rpb24ubmFtZSA9PSBmdW5jdGlvbl9uYW1lKQogICAgICAgIC5jb2xsZWN0Ojo8VmVjPF8+PigpOwoKICAgIGlmIGFsbF9jYW5kaWRhdGVzLmlzX2VtcHR5KCkgewogICAgICAgIHJldHVybiBFcnIoUnVudGltZUVycm9yOjpuZXcoZm9ybWF0ISgKICAgICAgICAgICAgIm1pc3NpbmcgcnVudGltZSBmdW5jdGlvbjoge2Z1bmN0aW9uX25hbWV9IgogICAgICAgICkpKTsKICAgIH0KCiAgICBsZXQgYXJpdHlfY2FuZGlkYXRlcyA9IGFsbF9jYW5kaWRhdGVzCiAgICAgICAgLml0ZXIoKQogICAgICAgIC5jb3BpZWQoKQogICAgICAgIC5maWx0ZXIofGZ1bmN0aW9ufCBmdW5jdGlvbi5wYXJhbXMubGVuKCkgPT0gYXJncy5sZW4oKSkKICAgICAgICAuY29sbGVjdDo6PFZlYzxfPj4oKTsKCiAgICBpZiBhcml0eV9jYW5kaWRhdGVzLmlzX2VtcHR5KCkgewogICAgICAgIGxldCBleHBlY3RlZF9hcml0eSA9IGFsbF9jYW5kaWRhdGVzCiAgICAgICAgICAgIC5maXJzdCgpCiAgICAgICAgICAgIC5tYXAofGZ1bmN0aW9ufCBmdW5jdGlvbi5wYXJhbXMubGVuKCkpCiAgICAgICAgICAgIC51bndyYXBfb3IoMCk7CgogICAgICAgIHJldHVybiBFcnIoUnVudGltZUVycm9yOjpuZXcoZm9ybWF0ISgKICAgICAgICAgICAgImFyaXR5IG1pc21hdGNoIGZvciBydW50aW1lIGZ1bmN0aW9uIHtmdW5jdGlvbl9uYW1lfTogZXhwZWN0ZWQge30gYXJncywgZm91bmQge30iLAogICAgICAgICAgICBleHBlY3RlZF9hcml0eSwKICAgICAgICAgICAgYXJncy5sZW4oKQogICAgICAgICkpKTsKICAgIH0KCiAgICBsZXQgbXV0IGZhbGxiYWNrX2d1YXJkX29mZnNldCA9IE5vbmU7CgogICAgZm9yIGZ1bmN0aW9uIGluIGFyaXR5X2NhbmRpZGF0ZXMgewogICAgICAgIGxldCBtdXQgZW52ID0gSGFzaE1hcDo6bmV3KCk7CgogICAgICAgIGlmIGxldCBTb21lKHBhdHRlcm5zKSA9ICZmdW5jdGlvbi5wYXJhbV9wYXR0ZXJucyB7CiAgICAgICAgICAgIGxldCBtdXQgbWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICAgIGZvciAocGF0dGVybiwgYXJnKSBpbiBwYXR0ZXJucy5pdGVyKCkuemlwKGFyZ3MuaXRlcigpKSB7CiAgICAgICAgICAgICAgICBsZXQgbXV0IGJpbmRpbmdzID0gSGFzaE1hcDo6bmV3KCk7CiAgICAgICAgICAgICAgICBpZiAhbWF0Y2hfcGF0dGVybihhcmcsIHBhdHRlcm4sICZlbnYsICZtdXQgYmluZGluZ3MpIHsKICAgICAgICAgICAgICAgICAgICBtYXRjaGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbnYuZXh0ZW5kKGJpbmRpbmdzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgIW1hdGNoZWQgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHBhcmFtLCBhcmcpIGluIGZ1bmN0aW9uLnBhcmFtcy5pdGVyKCkuemlwKGFyZ3MuaXRlcigpKSB7CiAgICAgICAgICAgICAgICBlbnYuaW5zZXJ0KHBhcmFtLmNsb25lKCksIGFyZy5jbG9uZSgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgbGV0IFNvbWUoZ3VhcmRfb3BzKSA9ICZmdW5jdGlvbi5ndWFyZF9vcHMgewogICAgICAgICAgICBsZXQgZ3VhcmRfcGFzc2VkID0gZXZhbHVhdGVfZ3VhcmRfb3BzKHByb2dyYW0sIGd1YXJkX29wcywgJm11dCBlbnYpPzsKICAgICAgICAgICAgaWYgIWd1YXJkX3Bhc3NlZCB7CiAgICAgICAgICAgICAgICBmYWxsYmFja19ndWFyZF9vZmZzZXQgPSBndWFyZF9vcHMuZmlyc3QoKS5tYXAoaXJfb3Bfb2Zmc2V0KTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsZXQgbXV0IHN0YWNrOiBWZWM8UnVudGltZVZhbHVlPiA9IFZlYzo6bmV3KCk7CgogICAgICAgIGlmIGxldCBTb21lKHJldCkgPSBldmFsdWF0ZV9vcHMocHJvZ3JhbSwgJmZ1bmN0aW9uLm9wcywgJm11dCBlbnYsICZtdXQgc3RhY2spPyB7CiAgICAgICAgICAgIHJldHVybiBPayhyZXQpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIEVycihSdW50aW1lRXJyb3I6Om5ldyhmb3JtYXQhKAogICAgICAgICAgICAicnVudGltZSBmdW5jdGlvbiBlbmRlZCB3aXRob3V0IHJldHVybjoge2Z1bmN0aW9uX25hbWV9IgogICAgICAgICkpKTsKICAgIH0KCiAgICBFcnIoUnVudGltZUVycm9yOjphdF9vZmZzZXQoCiAgICAgICAgZm9ybWF0ISgibm8gZnVuY3Rpb24gY2xhdXNlIG1hdGNoaW5nIHtmdW5jdGlvbl9uYW1lfSIpLAogICAgICAgIGZhbGxiYWNrX2d1YXJkX29mZnNldC51bndyYXBfb3IoY2FsbF9vZmZzZXQpLAogICAgKSkKfQoKZm4gZXZhbHVhdGVfb3BzKAogICAgcHJvZ3JhbTogJklyUHJvZ3JhbSwKICAgIG9wczogJltJck9wXSwKICAgIGVudjogJm11dCBIYXNoTWFwPFN0cmluZywgUnVudGltZVZhbHVlPiwKICAgIHN0YWNrOiAmbXV0IFZlYzxSdW50aW1lVmFsdWU+LAopIC0+IFJlc3VsdDxPcHRpb248UnVudGltZVZhbHVlPiwgUnVudGltZUVycm9yPiB7CiAgICBmb3Igb3AgaW4gb3BzIHsKICAgICAgICBtYXRjaCBvcCB7CiAgICAgICAgICAgIElyT3A6OkNvbnN0SW50IHsgdmFsdWUsIC4uIH0gPT4gc3RhY2sucHVzaChSdW50aW1lVmFsdWU6OkludCgqdmFsdWUpKSwKICAgICAgICAgICAgSXJPcDo6Q29uc3RGbG9hdCB7IHZhbHVlLCAuLiB9ID0+IHN0YWNrLnB1c2goUnVudGltZVZhbHVlOjpGbG9hdCh2YWx1ZS5jbG9uZSgpKSksCiAgICAgICAgICAgIElyT3A6OkNvbnN0Qm9vbCB7IHZhbHVlLCAuLiB9ID0+IHN0YWNrLnB1c2goUnVudGltZVZhbHVlOjpCb29sKCp2YWx1ZSkpLAogICAgICAgICAgICBJck9wOjpDb25zdE5pbCB7IC4uIH0gPT4gc3RhY2sucHVzaChSdW50aW1lVmFsdWU6Ok5pbCksCiAgICAgICAgICAgIElyT3A6OkNvbnN0U3RyaW5nIHsgdmFsdWUsIC4uIH0gPT4gc3RhY2sucHVzaChSdW50aW1lVmFsdWU6OlN0cmluZyh2YWx1ZS5jbG9uZSgpKSksCiAgICAgICAgICAgIElyT3A6OlRvU3RyaW5nIHsgb2Zmc2V0IH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAidG9fc3RyaW5nIik/OwogICAgICAgICAgICAgICAgbGV0IHN0cl92YWx1ZSA9IG1hdGNoIHZhbHVlIHsKICAgICAgICAgICAgICAgICAgICBSdW50aW1lVmFsdWU6OlN0cmluZyhzKSA9PiBzLAogICAgICAgICAgICAgICAgICAgIFJ1bnRpbWVWYWx1ZTo6SW50KGkpID0+IGkudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgUnVudGltZVZhbHVlOjpGbG9hdChmKSA9PiBmLmNsb25lKCksCiAgICAgICAgICAgICAgICAgICAgUnVudGltZVZhbHVlOjpCb29sKGIpID0+IGIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgUnVudGltZVZhbHVlOjpOaWwgPT4gU3RyaW5nOjpuZXcoKSwKICAgICAgICAgICAgICAgICAgICBSdW50aW1lVmFsdWU6OkF0b20oYSkgPT4gYSwKICAgICAgICAgICAgICAgICAgICBfID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEVycihSdW50aW1lRXJyb3I6OmF0X29mZnNldCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjYW5ub3QgaW50ZXJwb2xhdGUgY29tcGxleCB2YWx1ZSIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAqb2Zmc2V0LAogICAgICAgICAgICAgICAgICAgICAgICApKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKFJ1bnRpbWVWYWx1ZTo6U3RyaW5nKHN0cl92YWx1ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6OkNvbnN0QXRvbSB7IHZhbHVlLCAuLiB9ID0+IHN0YWNrLnB1c2goUnVudGltZVZhbHVlOjpBdG9tKHZhbHVlLmNsb25lKCkpKSwKICAgICAgICAgICAgSXJPcDo6TG9hZFZhcmlhYmxlIHsgbmFtZSwgb2Zmc2V0IH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gZW52LmdldChuYW1lKS5va19vcl9lbHNlKHx8IHsKICAgICAgICAgICAgICAgICAgICBSdW50aW1lRXJyb3I6OmF0X29mZnNldChmb3JtYXQhKCJ1bmRlZmluZWQgdmFyaWFibGU6IHtuYW1lfSIpLCAqb2Zmc2V0KQogICAgICAgICAgICAgICAgfSk/OwogICAgICAgICAgICAgICAgc3RhY2sucHVzaCh2YWx1ZS5jbG9uZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpDYWxsIHsKICAgICAgICAgICAgICAgIGNhbGxlZSwKICAgICAgICAgICAgICAgIGFyZ2MsCiAgICAgICAgICAgICAgICBvZmZzZXQsCiAgICAgICAgICAgIH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gZXZhbHVhdGVfY2FsbChwcm9ncmFtLCBjYWxsZWUsIHN0YWNrLCAqYXJnYywgKm9mZnNldCk/OwogICAgICAgICAgICAgICAgc3RhY2sucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSXJPcDo6TWFrZUNsb3N1cmUgeyBwYXJhbXMsIG9wcywgLi4gfSA9PiB7CiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKFJ1bnRpbWVWYWx1ZTo6Q2xvc3VyZShCb3g6Om5ldyhSdW50aW1lQ2xvc3VyZSB7CiAgICAgICAgICAgICAgICAgICAgcGFyYW1zOiBwYXJhbXMuY2xvbmUoKSwKICAgICAgICAgICAgICAgICAgICBvcHM6IG9wcy5jbG9uZSgpLAogICAgICAgICAgICAgICAgICAgIGVudjogZW52LmNsb25lKCksCiAgICAgICAgICAgICAgICB9KSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6OkNhbGxWYWx1ZSB7IGFyZ2MsIG9mZnNldCB9ID0+IHsKICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IGV2YWx1YXRlX2NhbGxfdmFsdWUocHJvZ3JhbSwgc3RhY2ssICphcmdjLCAqb2Zmc2V0KT87CiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpOb3QgeyBvZmZzZXQgfSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICJub3QiKT87CiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gbmF0aXZlX3J1bnRpbWU6Om9wczo6c3RyaWN0X25vdCh2YWx1ZSwgKm9mZnNldCkKICAgICAgICAgICAgICAgICAgICAubWFwX2VycihtYXBfbmF0aXZlX3J1bnRpbWVfZXJyb3IpPzsKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gocmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpCYW5nIHsgb2Zmc2V0IH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAiISIpPzsKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobmF0aXZlX3J1bnRpbWU6Om9wczo6dHJ1dGh5X2JhbmcodmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpBbmRBbmQgeyByaWdodF9vcHMsIG9mZnNldCB9ID0+IHsKICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgIiYmIik/OwogICAgICAgICAgICAgICAgbGV0IHRydXRoeSA9ICFtYXRjaGVzISh2YWx1ZSwgUnVudGltZVZhbHVlOjpOaWwgfCBSdW50aW1lVmFsdWU6OkJvb2woZmFsc2UpKTsKICAgICAgICAgICAgICAgIGlmIHRydXRoeSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBjaGlsZF9zdGFjayA9IFZlYzo6bmV3KCk7CiAgICAgICAgICAgICAgICAgICAgZXZhbHVhdGVfb3BzKHByb2dyYW0sIHJpZ2h0X29wcywgZW52LCAmbXV0IGNoaWxkX3N0YWNrKT87CiAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaChwb3BfdmFsdWUoJm11dCBjaGlsZF9zdGFjaywgKm9mZnNldCwgIiYmIik/KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSXJPcDo6T3JPciB7IHJpZ2h0X29wcywgb2Zmc2V0IH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAifHwiKT87CiAgICAgICAgICAgICAgICBsZXQgdHJ1dGh5ID0gIW1hdGNoZXMhKHZhbHVlLCBSdW50aW1lVmFsdWU6Ok5pbCB8IFJ1bnRpbWVWYWx1ZTo6Qm9vbChmYWxzZSkpOwogICAgICAgICAgICAgICAgaWYgdHJ1dGh5IHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBjaGlsZF9zdGFjayA9IFZlYzo6bmV3KCk7CiAgICAgICAgICAgICAgICAgICAgZXZhbHVhdGVfb3BzKHByb2dyYW0sIHJpZ2h0X29wcywgZW52LCAmbXV0IGNoaWxkX3N0YWNrKT87CiAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaChwb3BfdmFsdWUoJm11dCBjaGlsZF9zdGFjaywgKm9mZnNldCwgInx8Iik/KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpBbmQgeyByaWdodF9vcHMsIG9mZnNldCB9ID0+IHsKICAgICAgICAgICAgICAgIGxldCBsZWZ0ID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAiYW5kIik/OwogICAgICAgICAgICAgICAgbWF0Y2ggbGVmdCB7CiAgICAgICAgICAgICAgICAgICAgUnVudGltZVZhbHVlOjpCb29sKHRydWUpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG11dCBjaGlsZF9zdGFjayA9IFZlYzo6bmV3KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2YWx1YXRlX29wcyhwcm9ncmFtLCByaWdodF9vcHMsIGVudiwgJm11dCBjaGlsZF9zdGFjayk/OwogICAgICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKHBvcF92YWx1ZSgmbXV0IGNoaWxkX3N0YWNrLCAqb2Zmc2V0LCAiYW5kIik/KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgUnVudGltZVZhbHVlOjpCb29sKGZhbHNlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goUnVudGltZVZhbHVlOjpCb29sKGZhbHNlKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIF8gPT4gcmV0dXJuIEVycihSdW50aW1lRXJyb3I6OmF0X29mZnNldCgiYmFkYXJnIi50b19zdHJpbmcoKSwgKm9mZnNldCkpLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6Ok9yIHsgcmlnaHRfb3BzLCBvZmZzZXQgfSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgbGVmdCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgIm9yIik/OwogICAgICAgICAgICAgICAgbWF0Y2ggbGVmdCB7CiAgICAgICAgICAgICAgICAgICAgUnVudGltZVZhbHVlOjpCb29sKGZhbHNlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtdXQgY2hpbGRfc3RhY2sgPSBWZWM6Om5ldygpOwogICAgICAgICAgICAgICAgICAgICAgICBldmFsdWF0ZV9vcHMocHJvZ3JhbSwgcmlnaHRfb3BzLCBlbnYsICZtdXQgY2hpbGRfc3RhY2spPzsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaChwb3BfdmFsdWUoJm11dCBjaGlsZF9zdGFjaywgKm9mZnNldCwgIm9yIik/KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgUnVudGltZVZhbHVlOjpCb29sKHRydWUpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaChSdW50aW1lVmFsdWU6OkJvb2wodHJ1ZSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBfID0+IHJldHVybiBFcnIoUnVudGltZUVycm9yOjphdF9vZmZzZXQoImJhZGFyZyIudG9fc3RyaW5nKCksICpvZmZzZXQpKSwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpDb25jYXQgeyBvZmZzZXQgfSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgcmlnaHQgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICI8PiIpPzsKICAgICAgICAgICAgICAgIGxldCBsZWZ0ID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAiPD4iKT87CiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gbmF0aXZlX3J1bnRpbWU6Om9wczo6Y29uY2F0KGxlZnQsIHJpZ2h0LCAqb2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKG1hcF9uYXRpdmVfcnVudGltZV9lcnJvcik/OwogICAgICAgICAgICAgICAgc3RhY2sucHVzaChyZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6OkluIHsgb2Zmc2V0IH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHJpZ2h0ID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAiaW4iKT87CiAgICAgICAgICAgICAgICBsZXQgbGVmdCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgImluIik/OwogICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IG5hdGl2ZV9ydW50aW1lOjpvcHM6OmluX29wZXJhdG9yKGxlZnQsIHJpZ2h0LCAqb2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKG1hcF9uYXRpdmVfcnVudGltZV9lcnJvcik/OwogICAgICAgICAgICAgICAgc3RhY2sucHVzaChyZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6OlBsdXNQbHVzIHsgb2Zmc2V0IH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHJpZ2h0ID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAiKysiKT87CiAgICAgICAgICAgICAgICBsZXQgbGVmdCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgIisrIik/OwogICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IG5hdGl2ZV9ydW50aW1lOjpvcHM6Omxpc3RfY29uY2F0KGxlZnQsIHJpZ2h0LCAqb2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKG1hcF9uYXRpdmVfcnVudGltZV9lcnJvcik/OwogICAgICAgICAgICAgICAgc3RhY2sucHVzaChyZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6Ok1pbnVzTWludXMgeyBvZmZzZXQgfSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgcmlnaHQgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICItLSIpPzsKICAgICAgICAgICAgICAgIGxldCBsZWZ0ID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAiLS0iKT87CiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gbmF0aXZlX3J1bnRpbWU6Om9wczo6bGlzdF9zdWJ0cmFjdChsZWZ0LCByaWdodCwgKm9mZnNldCkKICAgICAgICAgICAgICAgICAgICAubWFwX2VycihtYXBfbmF0aXZlX3J1bnRpbWVfZXJyb3IpPzsKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gocmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpSYW5nZSB7IG9mZnNldCB9ID0+IHsKICAgICAgICAgICAgICAgIGxldCByaWdodCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgInJhbmdlIik/OwogICAgICAgICAgICAgICAgbGV0IGxlZnQgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICJyYW5nZSIpPzsKICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBuYXRpdmVfcnVudGltZTo6b3BzOjpyYW5nZShsZWZ0LCByaWdodCwgKm9mZnNldCkKICAgICAgICAgICAgICAgICAgICAubWFwX2VycihtYXBfbmF0aXZlX3J1bnRpbWVfZXJyb3IpPzsKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gocmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpOb3RJbiB7IG9mZnNldCB9ID0+IHsKICAgICAgICAgICAgICAgIGxldCByaWdodCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgIm5vdCBpbiIpPzsKICAgICAgICAgICAgICAgIGxldCBsZWZ0ID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAibm90IGluIik/OwogICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IG5hdGl2ZV9ydW50aW1lOjpvcHM6OmluX29wZXJhdG9yKGxlZnQsIHJpZ2h0LCAqb2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKG1hcF9uYXRpdmVfcnVudGltZV9lcnJvcik/OwogICAgICAgICAgICAgICAgLy8gTmVnYXRlIHRoZSBpbiByZXN1bHQKICAgICAgICAgICAgICAgIGxldCBuZWdhdGVkID0gbWF0Y2ggcmVzdWx0IHsKICAgICAgICAgICAgICAgICAgICBSdW50aW1lVmFsdWU6OkJvb2woYikgPT4gUnVudGltZVZhbHVlOjpCb29sKCFiKSwKICAgICAgICAgICAgICAgICAgICBvdGhlciA9PiBvdGhlciwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5lZ2F0ZWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6OkJpdHdpc2VBbmQgeyBvZmZzZXQgfSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgcmlnaHQgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICImJiYiKT87CiAgICAgICAgICAgICAgICBsZXQgbGVmdCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgIiYmJiIpPzsKICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBuYXRpdmVfcnVudGltZTo6b3BzOjpiaXR3aXNlX2FuZChsZWZ0LCByaWdodCwgKm9mZnNldCkKICAgICAgICAgICAgICAgICAgICAubWFwX2VycihtYXBfbmF0aXZlX3J1bnRpbWVfZXJyb3IpPzsKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gocmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpCaXR3aXNlT3IgeyBvZmZzZXQgfSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgcmlnaHQgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICJ8fHwiKT87CiAgICAgICAgICAgICAgICBsZXQgbGVmdCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgInx8fCIpPzsKICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBuYXRpdmVfcnVudGltZTo6b3BzOjpiaXR3aXNlX29yKGxlZnQsIHJpZ2h0LCAqb2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKG1hcF9uYXRpdmVfcnVudGltZV9lcnJvcik/OwogICAgICAgICAgICAgICAgc3RhY2sucHVzaChyZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6OkJpdHdpc2VYb3IgeyBvZmZzZXQgfSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgcmlnaHQgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICJeXl4iKT87CiAgICAgICAgICAgICAgICBsZXQgbGVmdCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgIl5eXiIpPzsKICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBuYXRpdmVfcnVudGltZTo6b3BzOjpiaXR3aXNlX3hvcihsZWZ0LCByaWdodCwgKm9mZnNldCkKICAgICAgICAgICAgICAgICAgICAubWFwX2VycihtYXBfbmF0aXZlX3J1bnRpbWVfZXJyb3IpPzsKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gocmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpCaXR3aXNlTm90IHsgb2Zmc2V0IH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAifn5+Iik/OwogICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IG5hdGl2ZV9ydW50aW1lOjpvcHM6OmJpdHdpc2Vfbm90KHZhbHVlLCAqb2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKG1hcF9uYXRpdmVfcnVudGltZV9lcnJvcik/OwogICAgICAgICAgICAgICAgc3RhY2sucHVzaChyZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6OkJpdHdpc2VTaGlmdExlZnQgeyBvZmZzZXQgfSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgcmlnaHQgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICI8PDwiKT87CiAgICAgICAgICAgICAgICBsZXQgbGVmdCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgIjw8PCIpPzsKICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBuYXRpdmVfcnVudGltZTo6b3BzOjpiaXR3aXNlX3NoaWZ0X2xlZnQobGVmdCwgcmlnaHQsICpvZmZzZXQpCiAgICAgICAgICAgICAgICAgICAgLm1hcF9lcnIobWFwX25hdGl2ZV9ydW50aW1lX2Vycm9yKT87CiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKHJlc3VsdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSXJPcDo6Qml0d2lzZVNoaWZ0UmlnaHQgeyBvZmZzZXQgfSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgcmlnaHQgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICI+Pj4iKT87CiAgICAgICAgICAgICAgICBsZXQgbGVmdCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgIj4+PiIpPzsKICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBuYXRpdmVfcnVudGltZTo6b3BzOjpiaXR3aXNlX3NoaWZ0X3JpZ2h0KGxlZnQsIHJpZ2h0LCAqb2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKG1hcF9uYXRpdmVfcnVudGltZV9lcnJvcik/OwogICAgICAgICAgICAgICAgc3RhY2sucHVzaChyZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6OlN0ZXBwZWRSYW5nZSB7IG9mZnNldCB9ID0+IHsKICAgICAgICAgICAgICAgIC8vIFN0YWNrOiAuLi4gcmFuZ2Ugc3RlcAogICAgICAgICAgICAgICAgbGV0IHN0ZXAgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICJzdGVwcGVkIHJhbmdlIHN0ZXAiKT87CiAgICAgICAgICAgICAgICBsZXQgcmFuZ2UgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICJzdGVwcGVkIHJhbmdlIHJhbmdlIik/OwogICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IG5hdGl2ZV9ydW50aW1lOjpvcHM6OnN0ZXBwZWRfcmFuZ2UocmFuZ2UsIHN0ZXAsICpvZmZzZXQpCiAgICAgICAgICAgICAgICAgICAgLm1hcF9lcnIobWFwX25hdGl2ZV9ydW50aW1lX2Vycm9yKT87CiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKHJlc3VsdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSXJPcDo6QWRkSW50IHsgb2Zmc2V0IH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHJpZ2h0ID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAiKyIpPzsKICAgICAgICAgICAgICAgIGxldCBsZWZ0ID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAiKyIpPzsKICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBuYXRpdmVfcnVudGltZTo6b3BzOjphZGRfaW50KGxlZnQsIHJpZ2h0LCAqb2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKG1hcF9uYXRpdmVfcnVudGltZV9lcnJvcik/OwogICAgICAgICAgICAgICAgc3RhY2sucHVzaChyZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6OlN1YkludCB7IG9mZnNldCB9ID0+IHsKICAgICAgICAgICAgICAgIGxldCByaWdodCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgIi0iKT87CiAgICAgICAgICAgICAgICBsZXQgbGVmdCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgIi0iKT87CiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gbmF0aXZlX3J1bnRpbWU6Om9wczo6c3ViX2ludChsZWZ0LCByaWdodCwgKm9mZnNldCkKICAgICAgICAgICAgICAgICAgICAubWFwX2VycihtYXBfbmF0aXZlX3J1bnRpbWVfZXJyb3IpPzsKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gocmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpNdWxJbnQgeyBvZmZzZXQgfSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgcmlnaHQgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICIqIik/OwogICAgICAgICAgICAgICAgbGV0IGxlZnQgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICIqIik/OwogICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IG5hdGl2ZV9ydW50aW1lOjpvcHM6Om11bF9pbnQobGVmdCwgcmlnaHQsICpvZmZzZXQpCiAgICAgICAgICAgICAgICAgICAgLm1hcF9lcnIobWFwX25hdGl2ZV9ydW50aW1lX2Vycm9yKT87CiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKHJlc3VsdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSXJPcDo6RGl2SW50IHsgb2Zmc2V0IH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHJpZ2h0ID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAiLyIpPzsKICAgICAgICAgICAgICAgIGxldCBsZWZ0ID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAiLyIpPzsKICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBuYXRpdmVfcnVudGltZTo6b3BzOjpkaXZfaW50KGxlZnQsIHJpZ2h0LCAqb2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKG1hcF9uYXRpdmVfcnVudGltZV9lcnJvcik/OwogICAgICAgICAgICAgICAgc3RhY2sucHVzaChyZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6OkNtcEludCB7IGtpbmQsIG9mZnNldCB9ID0+IHsKICAgICAgICAgICAgICAgIGxldCByaWdodCA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgImNtcCIpPzsKICAgICAgICAgICAgICAgIGxldCBsZWZ0ID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAiY21wIik/OwogICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IG5hdGl2ZV9ydW50aW1lOjpvcHM6OmNtcF9pbnQoKmtpbmQsIGxlZnQsIHJpZ2h0LCAqb2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKG1hcF9uYXRpdmVfcnVudGltZV9lcnJvcik/OwogICAgICAgICAgICAgICAgc3RhY2sucHVzaChyZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6Ok1hdGNoIHsgcGF0dGVybiwgb2Zmc2V0IH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gcG9wX3ZhbHVlKHN0YWNrLCAqb2Zmc2V0LCAibWF0Y2giKT87CiAgICAgICAgICAgICAgICBsZXQgbXV0IGJpbmRpbmdzID0gSGFzaE1hcDo6bmV3KCk7CgogICAgICAgICAgICAgICAgaWYgIW1hdGNoX3BhdHRlcm4oJnZhbHVlLCBwYXR0ZXJuLCBlbnYsICZtdXQgYmluZGluZ3MpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRXJyKFJ1bnRpbWVFcnJvcjo6YXRfb2Zmc2V0KAogICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQhKCJubyBtYXRjaCBvZiByaWdodCBoYW5kIHNpZGUgdmFsdWU6IHt9IiwgdmFsdWUucmVuZGVyKCkpLAogICAgICAgICAgICAgICAgICAgICAgICAqb2Zmc2V0LAogICAgICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvciAobmFtZSwgYm91bmRfdmFsdWUpIGluIGJpbmRpbmdzIHsKICAgICAgICAgICAgICAgICAgICBlbnYuaW5zZXJ0KG5hbWUsIGJvdW5kX3ZhbHVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpSZXR1cm4geyBvZmZzZXQgfSA9PiB7CiAgICAgICAgICAgICAgICByZXR1cm4gT2soU29tZShwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICJyZXR1cm4iKT8pKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBJck9wOjpRdWVzdGlvbiB7IG9mZnNldCB9ID0+IHsKICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IHBvcF92YWx1ZShzdGFjaywgKm9mZnNldCwgInF1ZXN0aW9uIik/OwoKICAgICAgICAgICAgICAgIG1hdGNoIHZhbHVlIHsKICAgICAgICAgICAgICAgICAgICBSdW50aW1lVmFsdWU6OlJlc3VsdE9rKGlubmVyKSA9PiBzdGFjay5wdXNoKCppbm5lciksCiAgICAgICAgICAgICAgICAgICAgUnVudGltZVZhbHVlOjpSZXN1bHRFcnIoaW5uZXIpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9rKFNvbWUoUnVudGltZVZhbHVlOjpSZXN1bHRFcnIoaW5uZXIpKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG90aGVyID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEVycihSdW50aW1lRXJyb3I6OmF0X29mZnNldCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdCEoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInF1ZXN0aW9uIGV4cGVjdHMgcmVzdWx0IHZhbHVlLCBmb3VuZCB7fSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3RoZXIua2luZF9sYWJlbCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKm9mZnNldCwKICAgICAgICAgICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIElyT3A6OkNhc2UgeyBicmFuY2hlcywgb2Zmc2V0IH0gPT4gewogICAgICAgICAgICAgICAgbGV0IHN1YmplY3QgPSBwb3BfdmFsdWUoc3RhY2ssICpvZmZzZXQsICJjYXNlIHN1YmplY3QiKT8KICAgICAgICAgICAga