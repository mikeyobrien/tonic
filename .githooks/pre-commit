#!/usr/bin/env bash
set -euo pipefail

if [[ "${SKIP_GIT_HOOKS:-0}" == "1" ]]; then
  printf '%s\n' "[pre-commit] SKIP_GIT_HOOKS=1, skipping checks"
  exit 0
fi

# Only run Rust checks when Rust files are staged for commit.
if ! git diff --cached --name-only --diff-filter=ACMR | grep -E '\.rs$' >/dev/null; then
  exit 0
fi

printf '%s\n' "[pre-commit] Running cargo fmt --all..."
cargo fmt --all

# Re-stage any tracked Rust files changed by rustfmt.
while IFS= read -r file; do
  [[ -n "$file" ]] || continue
  git add "$file"
done < <(git ls-files -m '*.rs')

printf '%s\n' "[pre-commit] Running cargo clippy --all-targets --all-features -- -D warnings..."
cargo clippy --all-targets --all-features -- -D warnings

printf '%s\n' "[pre-commit] rustfmt + clippy checks passed."
