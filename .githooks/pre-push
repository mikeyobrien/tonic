#!/usr/bin/env bash
set -euo pipefail

if [[ "${SKIP_GIT_HOOKS:-0}" == "1" ]]; then
  printf '%s\n' "[pre-push] SKIP_GIT_HOOKS=1, skipping checks"
  exit 0
fi

printf '%s\n' "[pre-push] Running cargo fmt --all -- --check..."
cargo fmt --all -- --check

printf '%s\n' "[pre-push] Running cargo clippy --all-targets --all-features -- -D warnings..."
cargo clippy --all-targets --all-features -- -D warnings

printf '%s\n' "[pre-push] Running cargo test..."
cargo test

if [[ "${RUN_NATIVE_GATES:-0}" == "1" ]]; then
  native_artifact_dir=".tonic/native-gates/pre-push"
  mkdir -p "$native_artifact_dir"

  printf '%s\n' "[pre-push] RUN_NATIVE_GATES=1, running differential + native benchmark policy gates..."
  ./scripts/differential-enforce.sh

  TONIC_BENCH_JSON_OUT="$native_artifact_dir/native-compiler-summary.json" \
  TONIC_BENCH_MARKDOWN_OUT="$native_artifact_dir/native-compiler-summary.md" \
  TONIC_BENCH_ENFORCE=0 \
  ./scripts/bench-native-contract-enforce.sh

  ./scripts/native-regression-policy.sh "$native_artifact_dir/native-compiler-summary.json" --mode strict
else
  printf '%s\n' "[pre-push] Skipping native benchmark gates (set RUN_NATIVE_GATES=1 to enable)."
fi

printf '%s\n' "[pre-push] All checks passed."
